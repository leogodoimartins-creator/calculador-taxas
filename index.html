<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ferramentas - Taxas & Troca</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f6fa;padding:20px;margin:0}
    .container{max-width:1100px;margin:auto}

    .card{background:white;padding:20px;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.08);margin-bottom:20px}
    h1{margin:0 0 10px 0}
    p{margin:0 0 16px 0;color:#555;line-height:1.35}
    label{display:block;margin:10px 0 6px 0;font-size:13px;color:#222}
    input, select{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px;outline:none;background:#fff}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{background:#eef2ff;color:#1f2a6a}
    .hint{font-size:12px;color:#666;margin-top:8px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .tabsWrap{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
    .tabBtn{
      border:1px solid #e5e7eb;background:#fff;padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:700;color:#111827
    }
    .tabBtn.active{background:#2563eb;border-color:#2563eb;color:#fff}

    details.accordion{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    details.accordion > summary{
      list-style:none;cursor:pointer;padding:14px 16px;background:#f9fafb;
      display:flex;align-items:center;justify-content:space-between;font-weight:700
    }
    details.accordion > summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(180deg)}
    .acc-body{padding:16px}
    .btn{width:100%;margin-top:10px;padding:12px;border:0;border-radius:12px;background:#2563eb;color:#fff;font-weight:700;font-size:14px;cursor:pointer}
    .btn-dark{background:#111827}
    .err{margin-top:10px;color:#b91c1c;font-size:13px}
    .hidden{display:none !important;}

    .kpi{padding:14px;border:1px solid #e5e7eb;border-radius:14px;background:#fafafa;margin-top:12px}
    .kpi strong{font-size:20px}
    .breakdown{margin-top:10px;color:#333;font-size:14px;line-height:1.4}
    .checkRow{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .checkRow input[type="checkbox"]{width:auto;transform:scale(1.1)}
    .pill{display:inline-block;padding:5px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px;color:#111827}

    /* Troca - descontos */
    .discBox{margin-top:14px;border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff}
    .discTitle{font-weight:800;margin:0 0 10px 0}
    .discList{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.discList{grid-template-columns:1fr}}
    .discItem{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #f0f0f0;border-radius:12px;padding:10px;background:#fafafa}
    .discLeft{display:flex;align-items:center;gap:10px}
    .discItem input[type="checkbox"]{width:auto;transform:scale(1.1)}
    .money{font-weight:800}
    .mini{font-size:12px;color:#6b7280;margin-top:2px}
    .lensRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid #f0f0f0;border-radius:12px;padding:10px;background:#fafafa}
    .lensRow select{max-width:140px}
    .warn{margin-top:10px;padding:10px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;font-size:13px}
  </style>
</head>

<body>
  <div class="container">

    <div class="tabsWrap">
      <button class="tabBtn active" id="tabCalc">Calculadora</button>
      <button class="tabBtn" id="tabTrade">Troca de Aparelhos</button>
    </div>

    <!-- TAB 1: CALCULADORA -->
    <section id="viewCalc">
      <div class="card">
        <h1>Calculadora de Taxas</h1>
        <p>Digite o <strong>valor à vista</strong>. A tabela mostra o <strong>valor final</strong> (somando taxa) e a <strong>parcela</strong>.</p>

        <label for="valor">Valor à vista (R$)</label>
        <input type="text" id="valor" placeholder="Ex: 1000 ou 1000,50" />
        <div class="hint">Você pode digitar com vírgula (ex: 1000,50). Não use símbolo R$.</div>
      </div>

      <div class="grid">
        <div class="card">
          <h2 style="margin:0">Máquina Física</h2>
          <div id="maquina" style="margin-top:10px;">Digite um valor acima.</div>
        </div>

        <div class="card">
          <h2 style="margin:0">Link de Pagamento</h2>
          <div id="link" style="margin-top:10px;">Digite um valor acima.</div>
        </div>
      </div>

      <!-- Accordion 1 -->
      <div class="card" style="margin-top:20px;">
        <details class="accordion" id="advAccordion">
          <summary>
            Área Avançada (Valor que recebe após taxa extra) <span class="chev">▾</span>
          </summary>

          <div class="acc-body">
            <p style="margin:0 0 12px;color:#555">
              Aqui mostramos apenas <strong>Parcelas</strong> e <strong>Valor que recebe</strong>, calculado como:<br>
              <strong>Valor que recebe</strong> = <em>Valor Final (tabela de cima)</em> − <em>(Valor Final × taxa extra)</em>
            </p>

            <div id="lockBox">
              <label for="pin">Senha</label>
              <input id="pin" type="password" placeholder="Digite a senha" />
              <button class="btn" id="btnUnlock">Desbloquear</button>
              <div class="err" id="lockMsg"></div>
              <div class="hint">Obs: trava visual (site estático).</div>
            </div>

            <div id="advancedBox" style="display:none;margin-top:14px;">
              <div class="grid">
                <div>
                  <h3 style="margin:0 0 8px;font-size:15px;">Máquina Física (valor que recebe)</h3>
                  <div id="maquinaExtra"></div>
                </div>
                <div>
                  <h3 style="margin:0 0 8px;font-size:15px;">Link de Pagamento (valor que recebe)</h3>
                  <div id="linkExtra"></div>
                </div>
              </div>

              <button class="btn btn-dark" id="btnLock">Bloquear</button>
            </div>
          </div>
        </details>
      </div>

      <!-- Accordion 2 -->
      <div class="card" style="margin-top:20px;">
        <details class="accordion" id="discountAccordion">
          <summary>
            Descontar taxas (Máquina + Link) em cima de um valor <span class="chev">▾</span>
          </summary>

          <div class="acc-body">
            <p style="margin:0 0 12px;color:#555">
              Digite um valor abaixo. A tabela calcula quanto você recebe ao <strong>descontar</strong> as taxas
              usando as mesmas porcentagens da taxa extra.<br>
              <strong>Valor que recebe</strong> = <em>Valor digitado</em> − <em>(Valor digitado × taxa%)</em>
            </p>

            <div id="lockBox2">
              <label for="pin2">Senha</label>
              <input id="pin2" type="password" placeholder="Digite a senha" />
              <button class="btn" id="btnUnlock2">Desbloquear</button>
              <div class="err" id="lockMsg2"></div>
              <div class="hint">Obs: trava visual (site estático).</div>
            </div>

            <div id="discountBox2" style="display:none;margin-top:14px;">
              <label for="valor2">Valor (R$)</label>
              <input type="text" id="valor2" placeholder="Ex: 1000 ou 1000,50" />
              <div class="hint">Esse valor é independente do valor à vista de cima.</div>

              <div class="grid" style="margin-top:12px;">
                <div>
                  <h3 style="margin:0 0 8px;font-size:15px;">Máquina (valor que recebe após desconto)</h3>
                  <div id="maquinaDesconto"></div>
                </div>
                <div>
                  <h3 style="margin:0 0 8px;font-size:15px;">Link (valor que recebe após desconto)</h3>
                  <div id="linkDesconto"></div>
                </div>
              </div>

              <button class="btn btn-dark" id="btnLock2">Bloquear</button>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- TAB 2: TROCA -->
    <section id="viewTrade" class="hidden">
      <div class="card">
        <h1>Troca de Aparelhos</h1>
        <p>
          <span class="pill">Base = menor GB do modelo</span>
          <span class="pill">Cada degrau de GB soma +R$ 50</span>
          <span class="pill">Bateria em manutenção: −R$ 150 (somente iPhone 13+)</span>
          <span class="pill">Exceção: 15 Pro+ e 16+ (preço fixo por GB)</span>
        </p>

        <div class="grid">
          <div>
            <label for="trade_model">Modelo</label>
            <select id="trade_model"></select>
          </div>
          <div>
            <label for="trade_storage">Armazenamento</label>
            <select id="trade_storage"></select>
            <div class="hint" id="trade_storage_hint"></div>
          </div>
        </div>

        <div class="checkRow">
          <input type="checkbox" id="trade_battery" />
          <label for="trade_battery" style="margin:0">Bateria em manutenção (−R$ 150 a partir do iPhone 13)</label>
        </div>

        <div class="kpi">
          <div class="hint">Valor para pagar no aparelho (troca) — antes das avarias</div>
          <strong id="trade_price">R$ 0,00</strong>
          <div class="breakdown" id="trade_breakdown"></div>
        </div>

        <div id="missingPartsWarn" class="warn hidden"></div>

        <div class="discBox">
          <p class="discTitle">Área de desconto (histórico do modelo)</p>
          <div class="hint">Marque as avarias abaixo. O total é descontado do valor da troca.</div>

          <div id="discList" class="discList"></div>

          <div class="lensRow" style="margin-top:10px;">
            <div>
              <div style="font-weight:800">Lente de câmera quebrada</div>
              <div class="mini" id="lensHint">Até 3 lentes • desconto por lente</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <select id="lensCount">
                <option value="0">0 lente</option>
                <option value="1">1 lente</option>
                <option value="2">2 lentes</option>
                <option value="3">3 lentes</option>
              </select>
              <div class="money" id="lensTotal">-R$ 0,00</div>
            </div>
          </div>

          <div class="kpi" style="margin-top:12px;">
            <div class="hint">Total de descontos (avarias + lentes)</div>
            <strong id="disc_total">R$ 0,00</strong>
            <div class="breakdown" id="disc_breakdown"></div>
          </div>

          <div class="kpi" style="margin-top:12px;">
            <div class="hint">Valor final a pagar na troca</div>
            <strong id="trade_final">R$ 0,00</strong>
          </div>
        </div>

      </div>
    </section>

  </div>

<script>
  /* =========================
     CALCULADORA
  ========================= */
  const MAQUINA = {
    debito: 1.30,
    credito: {
      1: 3.69, 2: 5.19, 3: 5.95, 4: 6.70, 5: 7.65, 6: 8.55,
      7: 9.40, 8: 10.30, 9: 11.20, 10: 12.10, 11: 13.10, 12: 13.90,
      13: 15.70, 14: 16.80, 15: 17.90, 16: 18.80, 17: 19.01, 18: 19.90
    }
  };

  const LINK = {
    credito: {
      1: 6.50, 2: 9.55, 3: 10.40, 4: 11.30, 5: 12.20, 6: 13.10,
      7: 14.00, 8: 15.90, 9: 16.80, 10: 17.50, 11: 18.60, 12: 19.50
    }
  };

  const EXTRA_MAQUINA = {
    0: 0.99,
    1: 3.39, 2: 4.40, 3: 5.40, 4: 5.70, 5: 5.80, 6: 5.99,
    7: 7.20, 8: 7.90, 9: 8.40, 10: 8.85, 11: 9.40, 12: 9.85,
    13: 11.40, 14: 11.90, 15: 12.75, 16: 12.80, 17: 12.85, 18: 12.90
  };

  const EXTRA_LINK = {
    1: 3.49, 2: 4.85, 3: 5.45, 4: 6.05, 5: 6.45, 6: 6.95,
    7: 8.00, 8: 8.60, 9: 9.10, 10: 9.40, 11: 10.20, 12: 10.75
  };

  const PIN_VALUE = "358000";
  const ADV_KEY_1 = "adv_unlocked_v2";
  const ADV_KEY_2 = "disc_unlocked_v2";

  function formatar(v){ return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }

  function parseBRL(raw) {
    const t = (raw || "").trim();
    if (!t) return null;
    const normalizado = t.replace(/\./g, "").replace(",", ".");
    const v = Number(normalizado);
    return Number.isFinite(v) ? v : null;
  }

  function lerValor(){ return parseBRL(document.getElementById("valor").value); }
  function lerValor2(){ return parseBRL(document.getElementById("valor2").value); }

  // ✅ CORRIGIDO: SOMAR TAXA (ex: 8800 + 13,9% = 10023,20)
  function valorFinalComTaxa(valorAvista, taxaPercent){
    const t = taxaPercent / 100;
    return valorAvista * (1 + t);
  }

  function montarTabela4(linhasHtml){
    return `
      <table>
        <thead><tr><th>Parcelas</th><th>Taxa</th><th>Valor Final</th><th>Parcela</th></tr></thead>
        <tbody>${linhasHtml}</tbody>
      </table>
    `;
  }

  function linha4(parcelasLabel, taxaPercent, valorFinal, parcela){
    const parcelaTxt = parcela == null ? "-" : formatar(parcela);
    return `
      <tr>
        <td>${parcelasLabel}</td>
        <td>${taxaPercent.toFixed(2)}%</td>
        <td>${formatar(valorFinal)}</td>
        <td>${parcelaTxt}</td>
      </tr>
    `;
  }

  function montarTabela2(linhasHtml){
    return `
      <table>
        <thead><tr><th>Parcelas</th><th>Valor que recebe</th></tr></thead>
        <tbody>${linhasHtml}</tbody>
      </table>
    `;
  }

  function linha2(parcelasLabel, valorRecebe){
    return `<tr><td>${parcelasLabel}</td><td><strong>${formatar(valorRecebe)}</strong></td></tr>`;
  }

  function taxaExtra(obj, key){
    const v = obj[key];
    return (typeof v === "number" && isFinite(v)) ? v : 0;
  }

  function showTab(which){
    const calcBtn = document.getElementById("tabCalc");
    const tradeBtn = document.getElementById("tabTrade");
    const calcView = document.getElementById("viewCalc");
    const tradeView = document.getElementById("viewTrade");

    if (which === "calc"){
      calcBtn.classList.add("active");
      tradeBtn.classList.remove("active");
      calcView.classList.remove("hidden");
      tradeView.classList.add("hidden");
    } else {
      tradeBtn.classList.add("active");
      calcBtn.classList.remove("active");
      tradeView.classList.remove("hidden");
      calcView.classList.add("hidden");
    }
  }

  function atualizar(){
    const alvoMaquina = document.getElementById("maquina");
    const alvoLink = document.getElementById("link");
    const valor = lerValor();

    if (!valor || valor <= 0){
      alvoMaquina.innerHTML = "Digite um valor acima.";
      alvoLink.innerHTML = "Digite um valor acima.";
      renderAvancado(null);
      return;
    }

    let linhasM = "";
    const vfDeb = valorFinalComTaxa(valor, MAQUINA.debito);
    linhasM += linha4("Débito", MAQUINA.debito, vfDeb, null);

    Object.keys(MAQUINA.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const taxa = MAQUINA.credito[p];
      const vf = valorFinalComTaxa(valor, taxa);
      const parc = vf / p;
      linhasM += linha4(`${p}x`, taxa, vf, parc);
    });
    alvoMaquina.innerHTML = montarTabela4(linhasM);

    let linhasL = "";
    Object.keys(LINK.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const taxa = LINK.credito[p];
      const vf = valorFinalComTaxa(valor, taxa);
      const parc = vf / p;
      linhasL += linha4(`${p}x`, taxa, vf, parc);
    });
    alvoLink.innerHTML = montarTabela4(linhasL);

    renderAvancado(valor);
  }

  function renderAvancado(valorAvista){
    const boxM = document.getElementById("maquinaExtra");
    const boxL = document.getElementById("linkExtra");
    if (!isUnlocked1()) return;

    if (!valorAvista){
      boxM.innerHTML = "<p>Digite um valor acima.</p>";
      boxL.innerHTML = "<p>Digite um valor acima.</p>";
      return;
    }

    // ⚠️ Aqui “valor que recebe” segue sua regra do accordion:
    // Valor Final (tabela de cima) − (Valor Final × taxa extra)
    let linhasM = "";
    {
      const vf = valorFinalComTaxa(valorAvista, MAQUINA.debito);
      const te = taxaExtra(EXTRA_MAQUINA, 0);
      const recebe = vf - (vf * (te/100));
      linhasM += linha2("Débito", recebe);
    }
    Object.keys(MAQUINA.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const vf = valorFinalComTaxa(valorAvista, MAQUINA.credito[p]);
      const te = taxaExtra(EXTRA_MAQUINA, p);
      const recebe = vf - (vf * (te/100));
      linhasM += linha2(`${p}x`, recebe);
    });
    boxM.innerHTML = montarTabela2(linhasM);

    let linhasL = "";
    Object.keys(LINK.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const vf = valorFinalComTaxa(valorAvista, LINK.credito[p]);
      const te = taxaExtra(EXTRA_LINK, p);
      const recebe = vf - (vf * (te/100));
      linhasL += linha2(`${p}x`, recebe);
    });
    boxL.innerHTML = montarTabela2(linhasL);
  }

  function renderDesconto2(){
    if (!isUnlocked2()) return;

    const valor = lerValor2();
    const boxM = document.getElementById("maquinaDesconto");
    const boxL = document.getElementById("linkDesconto");

    if (!valor || valor <= 0){
      boxM.innerHTML = "<p>Digite um valor acima.</p>";
      boxL.innerHTML = "<p>Digite um valor acima.</p>";
      return;
    }

    let linhasM = "";
    {
      const te = taxaExtra(EXTRA_MAQUINA, 0);
      const recebe = valor - (valor * (te/100));
      linhasM += linha2("Débito", recebe);
    }
    Object.keys(MAQUINA.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const te = taxaExtra(EXTRA_MAQUINA, p);
      const recebe = valor - (valor * (te/100));
      linhasM += linha2(`${p}x`, recebe);
    });
    boxM.innerHTML = montarTabela2(linhasM);

    let linhasL = "";
    Object.keys(LINK.credito).map(Number).sort((a,b)=>a-b).forEach(p=>{
      const te = taxaExtra(EXTRA_LINK, p);
      const recebe = valor - (valor * (te/100));
      linhasL += linha2(`${p}x`, recebe);
    });
    boxL.innerHTML = montarTabela2(linhasL);
  }

  function setUnlocked1(v){ v ? localStorage.setItem(ADV_KEY_1,"1") : localStorage.removeItem(ADV_KEY_1); }
  function isUnlocked1(){ return localStorage.getItem(ADV_KEY_1)==="1"; }
  function updateLockUI1(){
    const lockBox = document.getElementById("lockBox");
    const advancedBox = document.getElementById("advancedBox");
    if (isUnlocked1()){
      lockBox.style.display="none";
      advancedBox.style.display="block";
      renderAvancado(lerValor());
    } else {
      lockBox.style.display="block";
      advancedBox.style.display="none";
    }
  }

  function setUnlocked2(v){ v ? localStorage.setItem(ADV_KEY_2,"1") : localStorage.removeItem(ADV_KEY_2); }
  function isUnlocked2(){ return localStorage.getItem(ADV_KEY_2)==="1"; }
  function updateLockUI2(){
    const lockBox2 = document.getElementById("lockBox2");
    const discountBox2 = document.getElementById("discountBox2");
    if (isUnlocked2()){
      lockBox2.style.display="none";
      discountBox2.style.display="block";
      renderDesconto2();
    } else {
      lockBox2.style.display="block";
      discountBox2.style.display="none";
    }
  }

  /* =========================
     TROCA (bases atualizadas + novos modelos)
  ========================= */

  // IDs de modelo
  // XR, XS, XS_MAX, 11, 11_PRO, 11_PRO_MAX, 12, 12_PRO, 12_PRO_MAX,
  // 13, 13_PRO, 13_PRO_MAX, 14, 14_PLUS, 14_PRO, 14_PRO_MAX,
  // 15, 15_PLUS, 15_PRO, 15_PRO_MAX,
  // 16, 16E, 16_PLUS, 16_PRO, 16_PRO_MAX

  // === TABELAS DE PEÇAS (com regras que você definiu)
  function getScreen(modelId){
    const m = modelId;

    // 16e (novo)
    if (m==="16E") return 700;

    // 15 Plus (tela específica)
    if (m==="15_PLUS") return 1000;

    // 14 Plus = igual 14
    if (m==="14_PLUS") return 700;

    // 16 Plus = igual 16 (assumido)
    if (m==="16_PLUS") return 1300;

    // padrão antigo
    if (m==="XR") return 300;
    if (m==="XS") return 400;
    if (m==="XS_MAX") return 500;
    if (m==="11") return 350;
    if (m==="11_PRO") return 500;
    if (m==="11_PRO_MAX") return 600;
    if (m==="12" || m==="12_PRO") return 400;
    if (m==="12_PRO_MAX") return 900;
    if (m==="13") return 480;
    if (m==="13_PRO") return 1300;
    if (m==="13_PRO_MAX") return 1500;
    if (m==="14") return 700;
    if (m==="14_PRO") return 1400;
    if (m==="14_PRO_MAX") return 1900;
    if (m==="15") return 900;
    if (m==="15_PRO") return 1600;
    if (m==="15_PRO_MAX") return 2100;
    if (m==="16") return 1300;
    if (m==="16_PRO") return 1900;
    if (m==="16_PRO_MAX") return 2600;
    return 0;
  }

  function getRearCam(modelId){
    const m = modelId;

    // 14 Plus = igual 14
    if (m==="14_PLUS") return 330;

    // 15 Plus = igual 15
    if (m==="15_PLUS") return 380;

    // 16 Plus = igual 16 (assumido)
    if (m==="16_PLUS") return 500;

    // 16e: não informado -> 0
    if (m==="16E") return 0;

    if (m==="XR" || m==="XS") return 170;
    if (m==="XS_MAX") return 170;
    if (m==="11") return 180;
    if (m==="11_PRO" || m==="11_PRO_MAX") return 300;
    if (m==="12") return 300;
    if (m==="12_PRO") return 380;
    if (m==="12_PRO_MAX") return 400;
    if (m==="13") return 280;
    if (m==="13_PRO" || m==="13_PRO_MAX") return 400;
    if (m==="14") return 330;
    if (m==="14_PRO") return 380;
    if (m==="14_PRO_MAX") return 400;
    if (m==="15") return 380;
    if (m==="15_PRO") return 450;
    if (m==="15_PRO_MAX") return 480;
    if (m==="16") return 500;
    if (m==="16_PRO") return 550;
    if (m==="16_PRO_MAX") return 600;
    return 0;
  }

  function getFrontCam(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 350;
    if (m==="15_PLUS") return 400; // toda linha 15
    if (m==="16_PLUS") return 400; // mantendo padrão 15 (não informado)
    if (m==="16E") return 0;        // não informado

    if (m==="XR" || m==="XS" || m==="XS_MAX") return 250;
    if (m==="11" || m==="11_PRO" || m==="11_PRO_MAX") return 280;
    if (m==="12" || m==="12_PRO" || m==="12_PRO_MAX") return 300;
    if (m==="13") return 330;
    if (m==="13_PRO" || m==="13_PRO_MAX") return 380;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 350;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 400;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 400; // padrão 15
    return 0;
  }

  function getMic(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 330;
    if (m==="15_PLUS") return 450;
    if (m==="16_PLUS") return 450; // padrão 15
    if (m==="16E") return 0;       // não informado

    if (m==="XR" || m==="XS") return 180;
    if (m==="XS_MAX") return 200;
    if (m==="11") return 180;
    if (m==="11_PRO" || m==="11_PRO_MAX") return 300;
    if (m==="12" || m==="12_PRO") return 280;
    if (m==="12_PRO_MAX") return 300;
    if (m==="13") return 280;
    if (m==="13_PRO") return 330;
    if (m==="13_PRO_MAX") return 350;
    if (m==="14") return 330;
    if (m==="14_PRO" || m==="14_PRO_MAX") return 350;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 450;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 450; // padrão 15
    return 0;
  }

  function getSpeaker(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 180;
    if (m==="15_PLUS") return 250;
    if (m==="16_PLUS") return 250; // padrão 15
    if (m==="16E") return 0;       // não informado

    if (m==="XR" || m==="XS") return 120;
    if (m==="XS_MAX") return 120;
    if (m==="11") return 120;
    if (m==="11_PRO") return 140;
    if (m==="11_PRO_MAX") return 150;
    if (m==="12" || m==="12_PRO") return 130;
    if (m==="12_PRO_MAX") return 150;
    if (m==="13") return 130;
    if (m==="13_PRO" || m==="13_PRO_MAX") return 180;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 180;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 250;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 250; // padrão 15
    return 0;
  }

  function getButton(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 250;
    if (m==="15_PLUS") return 330;
    if (m==="16_PLUS") return 330; // padrão 15
    if (m==="16E") return 0;       // não informado

    if (m==="XR" || m==="XS" || m==="XS_MAX") return 180;
    if (m==="11") return 180;
    if (m==="11_PRO" || m==="11_PRO_MAX") return 200;
    if (m==="12" || m==="12_PRO") return 180;
    if (m==="12_PRO_MAX") return 230;
    if (m==="13") return 200;
    if (m==="13_PRO" || m==="13_PRO_MAX") return 250;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 250;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 330;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 330; // padrão 15
    return 0;
  }

  function getBackGlass(modelId){
    const m = modelId;

    if (m==="16E") return 280; // informado
    if (m==="14_PLUS") return 280; // igual 14
    if (m==="15_PLUS") return 330;
    if (m==="16_PLUS") return 380; // igual 16

    if (m==="XR" || m==="XS" || m==="XS_MAX") return 180;
    if (m==="11" || m==="11_PRO" || m==="11_PRO_MAX") return 200;
    if (m==="12" || m==="12_PRO" || m==="12_PRO_MAX") return 230;
    if (m==="13" || m==="13_PRO" || m==="13_PRO_MAX") return 250;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 280;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 330;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 380;
    return 0;
  }

  function getFaceID(modelId){
    const m = modelId;

    if (m==="16E") return 450;   // informado
    if (m==="14_PLUS") return 450;
    if (m==="15_PLUS") return 550;
    if (m==="16_PLUS") return 550; // padrão 15 (não informado para 16)

    if (m==="XR" || m==="XS" || m==="XS_MAX") return 250;
    if (m==="11" || m==="11_PRO" || m==="11_PRO_MAX") return 250;
    if (m==="12" || m==="12_PRO" || m==="12_PRO_MAX") return 300;
    if (m==="13" || m==="13_PRO" || m==="13_PRO_MAX") return 450;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 450;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 550;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 550; // padrão 15
    return 0;
  }

  function getBoard(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 700;
    if (m==="15_PLUS") return 1000;
    if (m==="16_PLUS") return 1200;
    if (m==="16E") return 0; // não informado

    if (m==="XR" || m==="XS" || m==="XS_MAX") return 350;
    if (m==="11" || m==="11_PRO" || m==="11_PRO_MAX") return 400;
    if (m==="12" || m==="12_PRO" || m==="12_PRO_MAX") return 500;
    if (m==="13" || m==="13_PRO" || m==="13_PRO_MAX") return 600;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 700;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 1000;
    if (m==="16" || m==="16_PRO" || m==="16_PRO_MAX") return 1200;
    return 0;
  }

  function getLensPer(modelId){
    const m = modelId;

    if (m==="14_PLUS") return 110;
    if (m==="15_PLUS") return 120;
    if (m==="16_PLUS") return 130; // igual 16 Plus/16 (sua regra: 16/16 Plus = 130; 16 Pro/Max = 150)
    if (m==="16E") return 0;        // não informado

    if (m==="XR") return 70;
    if (m==="11" || m==="11_PRO" || m==="11_PRO_MAX") return 80;
    if (m==="12" || m==="12_PRO" || m==="12_PRO_MAX") return 90;
    if (m==="13" || m==="13_PRO" || m==="13_PRO_MAX") return 100;
    if (m==="14" || m==="14_PRO" || m==="14_PRO_MAX") return 110;
    if (m==="15" || m==="15_PRO" || m==="15_PRO_MAX") return 120;
    if (m==="16") return 130;
    if (m==="16_PRO" || m==="16_PRO_MAX") return 150;
    return 0;
  }

  function buildDiscountsForModel(modelId){
    return [
      { id:"tela", label:"Tela (original)", value: getScreen(modelId) },
      { id:"camera_traseira", label:"Câmera traseira", value: getRearCam(modelId) },
      { id:"camera_frontal", label:"Câmera frontal", value: getFrontCam(modelId) },
      { id:"conector_mic", label:"Conector / Microfone (original)", value: getMic(modelId) },
      { id:"alto_falante", label:"Alto-falante", value: getSpeaker(modelId) },
      { id:"botao", label:"Botão", value: getButton(modelId) },
      { id:"vidro_traseiro", label:"Vidro traseiro", value: getBackGlass(modelId) },
      { id:"faceid", label:"Face ID", value: getFaceID(modelId) },
      { id:"placa", label:"Problema de placa", value: getBoard(modelId) }
    ];
  }

  function getMissingParts(modelId){
    const list = buildDiscountsForModel(modelId);
    const missing = [];
    for (const it of list){
      if (!it.value || it.value === 0){
        // não marca vidro/tela se for 0 em modelos antigos? (aqui é proposital p/ 16e)
        missing.push(it.label);
      }
    }
    const lens = getLensPer(modelId);
    if (!lens || lens === 0) missing.push("Lente de câmera (por lente)");
    return missing;
  }

  // === Bases atualizadas da troca + novos modelos
  const TRADE_MODELS = [
    { id:"XR", name:"iPhone XR", type:"tiered", base:200, minGen:10, storages:[64,128,256] },
    { id:"XS", name:"iPhone XS", type:"tiered", base:200, minGen:10, storages:[64,256,512] },
    { id:"XS_MAX", name:"iPhone XS Max", type:"tiered", base:300, minGen:10, storages:[64,256,512] },

    { id:"11", name:"iPhone 11", type:"tiered", base:450, minGen:11, storages:[64,128,256] },
    { id:"11_PRO", name:"iPhone 11 Pro", type:"tiered", base:650, minGen:11, storages:[64,256,512] },
    { id:"11_PRO_MAX", name:"iPhone 11 Pro Max", type:"tiered", base:750, minGen:11, storages:[64,256,512] },

    { id:"12", name:"iPhone 12", type:"tiered", base:700, minGen:12, storages:[64,128,256] },
    { id:"12_PRO", name:"iPhone 12 Pro", type:"tiered", base:900, minGen:12, storages:[128,256,512] },
    { id:"12_PRO_MAX", name:"iPhone 12 Pro Max", type:"tiered", base:1200, minGen:12, storages:[128,256,512] },

    { id:"13", name:"iPhone 13", type:"tiered", base:1400, minGen:13, storages:[128,256,512] },
    { id:"13_PRO", name:"iPhone 13 Pro", type:"tiered", base:1700, minGen:13, storages:[128,256,512,1024] },
    { id:"13_PRO_MAX", name:"iPhone 13 Pro Max", type:"tiered", base:1900, minGen:13, storages:[128,256,512,1024] },

    { id:"14", name:"iPhone 14", type:"tiered", base:1700, minGen:14, storages:[128,256,512] },
    { id:"14_PLUS", name:"iPhone 14 Plus", type:"tiered", base:2000, minGen:14, storages:[128,256,512] },
    { id:"14_PRO", name:"iPhone 14 Pro", type:"tiered", base:2200, minGen:14, storages:[128,256,512,1024] },
    { id:"14_PRO_MAX", name:"iPhone 14 Pro Max", type:"tiered", base:2600, minGen:14, storages:[128,256,512,1024] },

    { id:"15", name:"iPhone 15", type:"tiered", base:2350, minGen:15, storages:[128,256,512] },
    { id:"15_PLUS", name:"iPhone 15 Plus", type:"tiered", base:2500, minGen:15, storages:[128,256,512] },

    // fixos por GB
    { id:"15_PRO", name:"iPhone 15 Pro", type:"fixedByGB", minGen:15, prices:{128:2750,256:2950} },
    { id:"15_PRO_MAX", name:"iPhone 15 Pro Max", type:"fixedByGB", minGen:15, prices:{256:3600,512:3700} },

    { id:"16", name:"iPhone 16", type:"fixedByGB", minGen:16, prices:{128:3200,256:3300} },
    { id:"16E", name:"iPhone 16e", type:"fixedByGB", minGen:16, prices:{128:2200} },
    { id:"16_PLUS", name:"iPhone 16 Plus", type:"fixedByGB", minGen:16, prices:{128:3400} },

    { id:"16_PRO", name:"iPhone 16 Pro", type:"fixedByGB", minGen:16, prices:{128:4000,256:4150} },
    { id:"16_PRO_MAX", name:"iPhone 16 Pro Max", type:"fixedByGB", minGen:16, prices:{256:4800,512:4900} }
  ];

  function populateTradeModels(){
    const sel = document.getElementById("trade_model");
    sel.innerHTML = "";
    for (const m of TRADE_MODELS){
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      sel.appendChild(opt);
    }
  }

  function getModelById(id){
    return TRADE_MODELS.find(m => m.id === id) || TRADE_MODELS[0];
  }

  function populateStorageForModel(model){
    const storageSel = document.getElementById("trade_storage");
    const hint = document.getElementById("trade_storage_hint");
    storageSel.innerHTML = "";

    let storages = [];
    if (model.type === "fixedByGB"){
      storages = Object.keys(model.prices).map(Number).sort((a,b)=>a-b);
      hint.textContent = "Preço fixo por GB.";
    } else {
      storages = (model.storages || []).slice().sort((a,b)=>a-b);
      hint.textContent = "Base = menor GB do modelo. Cada degrau soma +R$ 50.";
    }

    for (const s of storages){
      const opt = document.createElement("option");
      opt.value = String(s);
      opt.textContent = (s === 1024) ? "1TB" : `${s}GB`;
      storageSel.appendChild(opt);
    }
  }

  function renderDiscountList(modelId){
    const box = document.getElementById("discList");
    box.innerHTML = "";
    const discounts = buildDiscountsForModel(modelId);

    for (const d of discounts){
      const row = document.createElement("div");
      row.className = "discItem";
      row.innerHTML = `
        <div class="discLeft">
          <input type="checkbox" data-disc="${d.id}">
          <div>
            <div style="font-weight:800">${d.label}</div>
            <div class="mini">Desconto: ${formatar(d.value)}</div>
          </div>
        </div>
        <div class="money">-${formatar(d.value)}</div>
      `;
      box.appendChild(row);
    }

    box.querySelectorAll('input[type="checkbox"][data-disc]').forEach(chk=>{
      chk.addEventListener("change", () => calcAll());
    });

    const per = getLensPer(modelId);
    document.getElementById("lensHint").textContent = `Até 3 lentes • desconto por lente: ${formatar(per)}`;
    document.getElementById("lensCount").value = "0";
    document.getElementById("lensTotal").textContent = `-${formatar(0)}`;
  }

  function calcBaseTrade(model, storage){
    if (model.type === "fixedByGB"){
      return { base: model.prices[storage] || 0, addStorage: 0, note: "Preço fixo por GB" };
    }
    const storages = (model.storages || []).slice().sort((a,b)=>a-b);
    const idx = storages.indexOf(storage);
    const steps = (idx >= 0) ? idx : 0;
    const addStorage = 50 * steps;
    return { base: model.base, addStorage, note: `Base = menor GB (${storages[0]}GB) | +R$50 por degrau` };
  }

  function calcDiscounts(modelId){
    const discounts = buildDiscountsForModel(modelId);

    const selected = new Set();
    document.querySelectorAll('#discList input[type="checkbox"][data-disc]').forEach(chk=>{
      if (chk.checked) selected.add(chk.getAttribute("data-disc"));
    });

    let total = 0;
    const lines = [];

    for (const d of discounts){
      if (selected.has(d.id)){
        total += Number(d.value) || 0;
        lines.push(`${d.label}: -${formatar(d.value)}`);
      }
    }

    const per = getLensPer(modelId);
    const count = Number(document.getElementById("lensCount").value || 0);
    const lensTotal = per * count;
    document.getElementById("lensTotal").textContent = `-${formatar(lensTotal)}`;

    if (lensTotal > 0){
      total += lensTotal;
      lines.push(`Lentes quebradas (${count}x): -${formatar(lensTotal)} (${formatar(per)}/lente)`);
    }

    return { total, lines };
  }

  function calcAll(){
    const modelId = document.getElementById("trade_model").value;
    const storage = Number(document.getElementById("trade_storage").value);
    const batteryMaint = document.getElementById("trade_battery").checked;
    const model = getModelById(modelId);

    const baseObj = calcBaseTrade(model, storage);

    let batteryDiscount = 0;
    if (batteryMaint && model.minGen >= 13) batteryDiscount = 150;

    const disc = calcDiscounts(modelId);

    const valueTrade = Math.max(0, baseObj.base + baseObj.addStorage - batteryDiscount);
    const finalPay = Math.max(0, valueTrade - disc.total);

    document.getElementById("trade_price").textContent = formatar(valueTrade);

    const storageLabel = (storage === 1024) ? "1TB" : `${storage}GB`;
    const breakdownLines = [];
    breakdownLines.push(`Modelo: ${model.name}`);
    breakdownLines.push(`Armazenamento: ${storageLabel}`);
    breakdownLines.push(`Regra: ${baseObj.note}`);
    breakdownLines.push(`Base: ${formatar(baseObj.base)}`);
    if (baseObj.addStorage > 0) breakdownLines.push(`+ Degraus de GB: ${formatar(baseObj.addStorage)}`);
    if (batteryMaint){
      if (model.minGen >= 13) breakdownLines.push(`− Bateria em manutenção: ${formatar(batteryDiscount)}`);
      else breakdownLines.push(`Bateria em manutenção: (não aplica desconto para este modelo)`);
    }
    breakdownLines.push(`————————————`);
    breakdownLines.push(`Valor antes das avarias: ${formatar(valueTrade)}`);
    document.getElementById("trade_breakdown").innerHTML = breakdownLines.join("<br>");

    document.getElementById("disc_total").textContent = formatar(disc.total);
    document.getElementById("disc_breakdown").innerHTML = disc.lines.length ? disc.lines.join("<br>") : "<span class='hint'>Nenhuma avaria marcada.</span>";
    document.getElementById("trade_final").textContent = formatar(finalPay);

    // aviso de peças faltando (principalmente 16e)
    const missing = getMissingParts(modelId).filter(x => x);
    const warnBox = document.getElementById("missingPartsWarn");
    if (modelId === "16E"){
      warnBox.classList.remove("hidden");
      warnBox.innerHTML = `<strong>Atenção (16e):</strong> você só informou <b>Tela</b>, <b>Vidro traseiro</b> e <b>Face ID</b>. O restante está como <b>R$0</b> no desconto.`;
    } else {
      warnBox.classList.add("hidden");
      warnBox.textContent = "";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("tabCalc").addEventListener("click", ()=>showTab("calc"));
    document.getElementById("tabTrade").addEventListener("click", ()=>showTab("trade"));

    document.getElementById("valor").addEventListener("input", atualizar);

    document.getElementById("btnUnlock").addEventListener("click", () => {
      const pin = (document.getElementById("pin").value || "").trim();
      const msg = document.getElementById("lockMsg");
      if (pin === PIN_VALUE){
        msg.textContent = "";
        setUnlocked1(true);
        updateLockUI1();
        document.getElementById("advAccordion").open = true;
      } else msg.textContent = "Senha incorreta.";
    });
    document.getElementById("btnLock").addEventListener("click", () => { setUnlocked1(false); updateLockUI1(); });

    document.getElementById("btnUnlock2").addEventListener("click", () => {
      const pin = (document.getElementById("pin2").value || "").trim();
      const msg = document.getElementById("lockMsg2");
      if (pin === PIN_VALUE){
        msg.textContent = "";
        setUnlocked2(true);
        updateLockUI2();
        document.getElementById("discountAccordion").open = true;
      } else msg.textContent = "Senha incorreta.";
    });
    document.getElementById("btnLock2").addEventListener("click", () => { setUnlocked2(false); updateLockUI2(); });

    document.getElementById("valor2").addEventListener("input", renderDesconto2);

    showTab("calc");
    updateLockUI1();
    updateLockUI2();
    atualizar();

    // Troca init
    populateTradeModels();
    const modelSel = document.getElementById("trade_model");
    const storageSel = document.getElementById("trade_storage");
    const batterySel = document.getElementById("trade_battery");
    const lensSel = document.getElementById("lensCount");

    function refreshModel(){
      const model = getModelById(modelSel.value);
      populateStorageForModel(model);
      renderDiscountList(modelSel.value);
      document.querySelectorAll('#discList input[type="checkbox"][data-disc]').forEach(chk => chk.checked = false);
      lensSel.value = "0";
      calcAll();
    }

    modelSel.addEventListener("change", refreshModel);
    storageSel.addEventListener("change", calcAll);
    batterySel.addEventListener("change", calcAll);
    lensSel.addEventListener("change", calcAll);

    refreshModel();
  });
</script>

</body>
</html>
